name: Railway Debug Assistant
on:
  workflow_run:
    workflows: ["CI - tests & failure diagnostics"]
    types:
      - completed
    branches:
      - main
      - develop

jobs:
  analyze-and-debug:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create debug issue for CI failure
        uses: actions/github-script@v7
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get workflow run details
            const runId = context.payload.workflow_run.id;
            const runNumber = context.payload.workflow_run.run_number;
            const commitSha = context.payload.workflow_run.head_sha;
            const branch = context.payload.workflow_run.head_branch;
            const workflowName = context.payload.workflow_run.name;
            
            // Create issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ CI Failure - ${workflowName} #${runNumber}`,
              body: `
              ## CI Pipeline Failure Detected
              
              **Workflow:** ${workflowName}
              **Run Number:** #${runNumber}
              **Branch:** ${branch}
              **Commit:** ${commitSha.substring(0, 7)}
              **Status:** Failed
              
              **Links:**
              - [Failed Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId})
              - [Commit](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${commitSha})
              
              **Artifacts Available:**
              - pytest-report
              - railway-logs
              
              **Action Required:**
              1. Check test reports in artifacts
              2. Review Railway logs if applicable
              3. Fix the failing tests
              4. Re-run the workflow
              
              **To download artifacts:**
              \`\`\`
              gh run download ${runId} --repo ${context.repo.owner}/${context.repo.repo}
              \`\`\`
              `,
              labels: ['ci-failure', 'bug', 'needs-investigation']
            });
            
            console.log(`âœ… Created issue #${issue.data.number} for failed CI run`);
            
            // Try to get artifact info
            try {
              const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });
              
              if (artifacts.artifacts.length > 0) {
                const artifactList = artifacts.artifacts.map(a => `- ${a.name} (${Math.round(a.size_in_bytes / 1024)}KB)`).join('\n');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.data.number,
                  body: `## Available Artifacts\n\n${artifactList}\n\nDownload from Actions tab or use the CLI command above.`
                });
              }
            } catch (error) {
              console.log('Could not fetch artifacts:', error.message);
            }
